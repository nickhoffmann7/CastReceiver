<!DOCTYPE html>
<html lang="en">

<head>
    <script type="text/javascript"
            src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js">
    </script>

    <style>
        cast-media-player {
            --progress-color: rgb(120, 0, 46);
            --splash-image: url('loader.svg');
        }
    </style>
</head>

<body>

<cast-media-player></cast-media-player>

<script>
    console.log("started 1.1");
    const context = cast.framework.CastReceiverContext.getInstance();
    const playerManager = context.getPlayerManager();

    const channel = "urn:x-cast:streamcast";

    let hlsformat = false;

    context.addCustomMessageListener(
        channel,
        message => {
            let data = message.data;

            let msg = data.message;

            console.log("received message: " + msg);

            if (msg.includes("hlsformat=")) {
                hlsformat = (msg === "hlsformat=true");

            } else if (msg.includes("cookies=")) {
                let enabled = (msg === "cookies=true");

                let playbackConfig = Object.assign(new cast.framework.PlaybackConfig(), playerManager.getPlaybackConfig());
                playbackConfig.manifestRequestHandler = requestInfo => {
                    requestInfo.withCredentials = enabled;
                };
                playbackConfig.segmentRequestHandler = requestInfo => {
                    requestInfo.withCredentials = enabled;
                };
                playbackConfig.licenseRequestHandler = requestInfo => {
                    requestInfo.withCredentials = enabled;
                };

                playerManager.setPlaybackConfig(playbackConfig);
            }

            context.sendCustomMessage(channel, undefined, "ok done: " + msg);


            /*
            console.log("subs received: " + subs)

            let blob = new Blob([subs], {type: "text/vtt"});
            let url = URL.createObjectURL(blob);
            console.log("blob url created: " + url);

            let tracksManager = playerManager.getTextTracksManager();

            let track = tracksManager.createTrack();
            track.trackId = 9;
            track.type = cast.framework.messages.TrackType.TEXT;
            track.subtype = "SUBTITLES";
            track.name = "opensubtitles";
            track.language = "en-US";
            track.trackContentId = url;

            console.log("track created")

            tracksManager.addTracks([track]);

            console.log("track added")
            */

            //let response = {"message": "ok got it"};
            //context.sendCustomMessage(channel, undefined, "ok got it: " + msg);
        }
    );

    playerManager.setMessageInterceptor(
        cast.framework.messages.MessageType.LOAD,
        requestData => {

            if (hlsformat) {
                requestData.media.hlsVideoSegmentFormat = cast.framework.messages.HlsVideoSegmentFormat.MPEG2_TS;
            } else {
                requestData.media.hlsVideoSegmentFormat = cast.framework.messages.HlsVideoSegmentFormat.FMP4;
            }

            console.log(playerManager.getPlaybackConfig());
            return requestData;
        }
    );

    //context.start({playbackConfig: getPlaybackConfig()});
    context.start();

    function getPlaybackConfig() {
        const playbackConfig = new cast.framework.PlaybackConfig();

        //playbackConfig.autoPauseDuration = 2;
        playbackConfig.autoResumeDuration = 5;
        //playbackConfig.autoResumeNumberOfSegments = 1;
        //playbackConfig.segmentRequestRetryLimit = 0;

        /*
        playbackConfig.manifestRequestHandler = requestInfo => {
            requestInfo.withCredentials = true;
        };
        */

        return playbackConfig;
    }
</script>

</body>

</html>
